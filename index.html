<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Talking Archives - PoC</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h1 class="text-4xl font-bold text-indigo-900 mb-2">Talking Archives</h1>
        <p class="text-gray-600">AI-powered search for Indigenous historical documents</p>
        <p class="text-sm text-indigo-600 mt-2">‚úì Data Sovereignty ‚Ä¢ ‚úì Access Control ‚Ä¢ ‚úì Temporal Reasoning</p>
    </div>

    <!-- Search Box -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Ask a question about the documents:
            </label>
            <input
                    id="question"
                    type="text"
                    placeholder="e.g., What organizations are mentioned? What events happened over time?"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none text-lg"
                    onkeypress="if(event.key==='Enter') search()"
            >
        </div>

        <!-- Example queries -->
        <div class="mb-4">
            <p class="text-xs text-gray-500 mb-2">Try these examples:</p>
            <div class="flex flex-wrap gap-2">
                <button onclick="setQuery('What are the main topics?')"
                        class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700">
                    Main topics
                </button>
                <button onclick="setQuery('What organizations are mentioned?')"
                        class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700">
                    Organizations
                </button>
                <button onclick="setQuery('Show me relationships between entities')"
                        class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700">
                    Relationships
                </button>
                <button onclick="setQuery('What events happened over time?')"
                        class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700">
                    Timeline
                </button>
            </div>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Focus on entity types (optional):
            </label>
            <div class="flex flex-wrap gap-2 text-sm" id="entity-type-filters">
                <span class="text-gray-500">No types yet. Run a query first.</span>
            </div>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Temporarily exclude sources (optional):
                <a href="#" onclick="resetAllExcludedSources(); return false;" 
                   class="ml-2 text-xs text-indigo-600 hover:text-indigo-800 underline">
                    reset-all
                </a>
            </label>
            <div class="flex flex-wrap gap-2 text-sm" id="exclude-sources-filters">
                <span class="text-gray-500">Loading sources...</span>
            </div>
        </div>

        <button
                onclick="search()"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 text-lg"
        >
            üîç Search Archives
        </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex items-center justify-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mr-3"></div>
            <span class="text-gray-600">Searching knowledge graph and documents...</span>
        </div>
    </div>

    <!-- Results -->
    <div id="results" class="hidden bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">üìÑ Answer</h2>
        <div id="answer" class="prose max-w-none mb-6 text-gray-800 whitespace-pre-wrap"></div>

        <!-- Knowledge Graph Section -->
        <div id="graph-section" class="border-t pt-4 mb-4 hidden">
            <h3 class="text-lg font-semibold text-gray-900 mb-3">üï∏Ô∏è Knowledge Graph</h3>

            <div class="mb-4">
                <h4 class="font-medium text-gray-700 mb-2 text-sm">Entities Found:</h4>
                <div id="entities" class="flex flex-wrap gap-2"></div>
            </div>

            <div id="relationships-container" class="hidden">
                <h4 class="font-medium text-gray-700 mb-2 text-sm">Follow-up Questions:</h4>
                <ul id="relationships" class="space-y-2 text-sm"></ul>
            </div>

            <div id="episodes-container" class="hidden mt-4">
                <h4 class="font-medium text-gray-700 mb-2 text-sm">Episodes:</h4>
                <ul id="episodes" class="space-y-2 text-sm"></ul>
            </div>

            <!-- Graph Viewer Link -->
            <div id="embedded-graph-container" class="hidden mt-4">
                <h4 class="font-medium text-gray-700 mb-2 text-sm">Interactive Graph View (Graphiti UI):</h4>
                <a
                    id="graph-view-link"
                    href="#"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors text-sm"
                >
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                    Open Graphiti Graph Viewer in New Window
                </a>
                <div id="query-context" class="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600">
                    <span class="font-medium">Query:</span> <span id="query-text" class="font-mono"></span>
                </div>
                <p class="mt-2 text-xs text-gray-500">
                    Opens the interactive graph visualization. You can search for entities or terms in the Graphiti UI.
                </p>
            </div>
        </div>

        <!-- Sources Section -->
        <div id="sources-section" class="border-t pt-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-3">üìö Sources</h3>
            <ul id="sources" class="space-y-2"></ul>
        </div>
    </div>

    <!-- Footer -->
    <div class="mt-8 text-center text-gray-600 text-sm">
        <p class="font-semibold text-indigo-700">48-Hour Proof of Concept</p>
        <p class="mt-2">Architecture: Graphiti (Knowledge Graph) + Qdrant (Vector Search) + OpenAI (LLM)</p>
        <div class="mt-3 flex justify-center gap-4 text-xs">
            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">‚úì Data Sovereignty</span>
            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">‚úì Access Control</span>
            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">‚úì Audit Trail</span>
        </div>
    </div>

    <!-- Source Management -->
    <div class="mt-10 bg-white rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Source Management</h3>
                <p class="text-sm text-gray-500">Re-ingest individual documents after updates or removals.</p>
            </div>
            <button
                onclick="loadSources()"
                class="px-3 py-2 text-sm font-semibold text-indigo-700 border border-indigo-200 rounded-md hover:bg-indigo-50 transition"
            >
                Refresh List
            </button>
        </div>
        <div id="source-status" class="text-sm text-gray-500 mb-3 hidden"></div>
        <ul id="sources-list" class="space-y-2 text-sm text-gray-800"></ul>
    </div>

    <!-- OCR Upload Section -->
    <div class="mt-10 bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-3">Upload Document for OCR</h3>
        <p class="text-sm text-gray-500 mb-4">Upload images (JPG, PNG, TIFF) or PDF files to extract text using OCR and add to the archive.</p>
        
        <div class="mb-4">
            <label for="ocr-file" class="block text-sm font-medium text-gray-700 mb-2">
                Select file (PDF, JPG, PNG, TIFF):
            </label>
            <input 
                type="file" 
                id="ocr-file" 
                accept=".pdf,.jpg,.jpeg,.png,.tiff,.tif"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
            >
        </div>
        
        <div class="mb-4">
            <label for="ocr-doc-name" class="block text-sm font-medium text-gray-700 mb-2">
                Document Name (optional, defaults to filename):
            </label>
            <input 
                type="text" 
                id="ocr-doc-name" 
                placeholder="e.g., Scanned Letter 1920"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
            >
        </div>
        
        <button 
            onclick="uploadOCR()" 
            id="ocr-upload-button"
            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 text-sm"
        >
            üìÑ Upload and Extract Text (OCR)
        </button>
        
        <div id="ocr-status" class="mt-3 text-sm hidden">
            <div class="flex items-center">
                <div id="ocr-spinner" class="animate-spin rounded-full h-4 w-4 border-b-2 border-green-600 mr-2 hidden"></div>
                <span id="ocr-message" class="text-gray-600"></span>
            </div>
        </div>
        
        <!-- OCR Preview Section -->
        <div id="ocr-preview" class="hidden mt-4 p-4 border border-green-200 rounded-lg bg-green-50">
            <h4 class="font-medium text-green-800 mb-2 text-sm">Extracted Text Preview:</h4>
            <textarea 
                id="ocr-extracted-text" 
                rows="8"
                class="w-full p-3 border border-green-300 rounded-lg bg-white text-gray-800 text-xs font-mono" 
                readonly
            ></textarea>
        </div>
    </div>
</div>

<script>
    // Dynamic API base URL - uses current hostname so it works from remote PCs
    const API_BASE = `${window.location.protocol}//${window.location.hostname}:8080`;
    // Graphiti UI base URL (for embedded /graph view)
    const GRAPH_BASE = `${window.location.protocol}//${window.location.hostname}:3000`;
    
    let selectedEntityTypes = new Set();
    let excludedSources = new Set();
    let isSearching = false;

    function setQuery(text) {
        document.getElementById('question').value = text;
        document.getElementById('question').focus();
    }

    async function search() {
        if (isSearching) return;
        const question = document.getElementById('question').value.trim();
        const selectedTypes = Array.from(selectedEntityTypes);
        const excluded = Array.from(excludedSources);

        if (!question) {
            alert('Please enter a question');
            return;
        }

        // Show loading, hide results
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('results').classList.add('hidden');

        isSearching = true;
        try {
            const response = await fetch(`${API_BASE}/query`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    user_id: 'researcher_1',
                    entity_types: selectedTypes,
                    excluded_sources: excluded
                })
            });

            const data = await response.json();
            populateEntityFilters(data.available_entity_types || []);

            // Hide loading
            document.getElementById('loading').classList.add('hidden');

            // Show answer
            document.getElementById('answer').textContent = data.answer;

            // Show knowledge graph data
            const graphSection = document.getElementById('graph-section');
            if (data.graph_entities && data.graph_entities.length > 0) {
                graphSection.classList.remove('hidden');

                // Update Graphiti graph viewer link (just link to /graph, no query params)
                const graphWidget = document.getElementById('embedded-graph-container');
                const graphLink = document.getElementById('graph-view-link');
                const queryText = document.getElementById('query-text');
                if (graphWidget && graphLink) {
                    // Link directly to /graph - the UI doesn't accept query parameters
                    graphLink.href = `${GRAPH_BASE}/graph`;
                    // Display the query text so users can copy/search in the UI
                    if (queryText) {
                        queryText.textContent = question;
                    }
                    graphWidget.classList.remove('hidden');
                }

                const entitiesDiv = document.getElementById('entities');
                entitiesDiv.innerHTML = '';

                data.graph_entities.forEach(entity => {
                    const isSpecialized = entity.type && entity.type !== 'Entity';
                    const label = isSpecialized
                        ? `${entity.name || 'Unknown'} (${entity.type})`
                        : (entity.name || 'Unknown');

                    // Create container for entity button with source info
                    const container = document.createElement('div');
                    container.className = 'flex flex-col items-start';
                    
                    const button = document.createElement('button');
                    button.className = 'px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm font-medium hover:bg-indigo-200 transition';
                    button.textContent = label;
                    button.addEventListener('click', () => {
                        if (entity.name) {
                            askFollowUp(`Tell me more about ${entity.name}`);
                        }
                    });
                    container.appendChild(button);
                    
                    // Show document source if available
                    if (entity.doc_id || entity.group_id) {
                        const sourceSpan = document.createElement('span');
                        sourceSpan.className = 'text-xs text-gray-500 ml-3 mt-1';
                        const docName = entity.doc_id || entity.group_id;
                        sourceSpan.textContent = `üìÑ ${docName}`;
                        container.appendChild(sourceSpan);
                    }
                    
                    // Show warning if entity verification failed
                    if (entity._verification_failed) {
                        const warningSpan = document.createElement('span');
                        warningSpan.className = 'text-xs text-orange-600 ml-3 mt-1 italic';
                        warningSpan.textContent = `‚ö†Ô∏è Not found in ${entity._verification_failed}`;
                        container.appendChild(warningSpan);
                    }
                    
                    // Show warning if entity not found in any document
                    if (entity._not_found_in_docs) {
                        const warningSpan = document.createElement('span');
                        warningSpan.className = 'text-xs text-orange-600 ml-3 mt-1 italic';
                        warningSpan.textContent = `‚ö†Ô∏è Not found in documents`;
                        container.appendChild(warningSpan);
                    }
                    
                    entitiesDiv.appendChild(container);
                });

                // Show relationships if present
                if (data.graph_relationships && data.graph_relationships.length > 0) {
                    document.getElementById('relationships-container').classList.remove('hidden');

                    const relsList = document.getElementById('relationships');
                    relsList.innerHTML = '';

                data.graph_relationships.forEach(rel => {
                    const li = document.createElement('li');
                    li.className = 'text-gray-700';

                    if (rel.followup_question) {
                        const button = document.createElement('button');
                        button.className = 'text-sm text-indigo-700 font-semibold hover:underline bg-indigo-50 rounded-lg border border-indigo-200 px-3 py-2 w-full text-left hover:bg-indigo-100 transition-colors flex items-center space-x-2';
                        button.innerHTML = `<span class="text-base">üí≠</span> <span>${rel.followup_question}</span>`;
                        button.addEventListener('click', () => askFollowUp(rel.followup_question));
                        li.appendChild(button);
                    }

                    relsList.appendChild(li);
                });
                } else {
                    document.getElementById('relationships-container').classList.add('hidden');
                }
            } else {
                graphSection.classList.add('hidden');
                populateEntityFilters([]);
            }

            const episodesContainer = document.getElementById('episodes-container');
            const episodesList = document.getElementById('episodes');
            if (data.graph_episodes && data.graph_episodes.length > 0) {
                graphSection.classList.remove('hidden');
                episodesContainer.classList.remove('hidden');
                episodesList.innerHTML = '';

                data.graph_episodes.forEach(episode => {
                    const li = document.createElement('li');
                    li.className = 'text-gray-700 border border-gray-200 rounded-lg p-3 space-y-2';

                    const title = document.createElement('div');
                    title.className = 'font-semibold text-indigo-800';
                    title.textContent = episode.name || 'Unnamed episode';
                    li.appendChild(title);

                    const date = document.createElement('div');
                    date.className = 'text-xs text-gray-500';
                    date.textContent = episode.reference_time || 'Unknown date';
                    li.appendChild(date);

                    const rawContent = (episode.content || '').trim();
                    const cleanedContent = rawContent.replace(/^\[Reference Time:[^\]]+\]\s*/i, '');
                    const previewLimit = 600;
                    const isTruncated = cleanedContent.length > previewLimit;
                    const previewText = isTruncated ? `${cleanedContent.slice(0, previewLimit).trim()}‚Ä¶` : cleanedContent;

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'text-sm text-gray-700 whitespace-pre-line bg-gray-50 border border-gray-100 rounded-md p-3';
                    contentDiv.textContent = previewText || 'No content available';
                    contentDiv.dataset.fullText = cleanedContent;
                    contentDiv.dataset.previewText = previewText;
                    contentDiv.dataset.expanded = 'false';
                    li.appendChild(contentDiv);

                    if (isTruncated) {
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'text-xs text-indigo-700 font-semibold hover:underline';
                        toggleBtn.textContent = 'Show full text';
                        toggleBtn.addEventListener('click', () => {
                            const expanded = contentDiv.dataset.expanded === 'true';
                            contentDiv.dataset.expanded = (!expanded).toString();
                            contentDiv.textContent = expanded ? contentDiv.dataset.previewText : contentDiv.dataset.fullText;
                            toggleBtn.textContent = expanded ? 'Show full text' : 'Show less';
                        });
                        li.appendChild(toggleBtn);
                    }

                    episodesList.appendChild(li);
                });
            } else {
                episodesContainer.classList.add('hidden');
            }

            // Show sources
            const sourcesList = document.getElementById('sources');
            sourcesList.innerHTML = '';

            if (data.sources && data.sources.length > 0) {
                data.sources.forEach(source => {
                    const li = document.createElement('li');
                    li.className = 'flex items-start';
                    li.innerHTML = `
                        <span class="text-indigo-600 mr-2 mt-1">‚Ä¢</span>
                        <span class="text-gray-700">
                            <strong>${source.title}</strong>
                            <span class="text-gray-500 text-sm">(relevance: ${Math.min(source.relevance * 100, 100).toFixed(1)}%)</span>
                        </span>
                    `;
                    sourcesList.appendChild(li);
                });
            } else {
                sourcesList.innerHTML = '<li class="text-gray-500 italic">No sources found</li>';
            }

            document.getElementById('results').classList.remove('hidden');

        } catch (error) {
            document.getElementById('loading').classList.add('hidden');
            alert('Error: ' + error.message);
            console.error(error);
        } finally {
            isSearching = false;
        }
    }

    // Focus on input on load
    window.onload = () => {
        document.getElementById('question').focus();
        loadSources();
    };

    function askFollowUp(question) {
        const input = document.getElementById('question');
        input.value = question;
        search();
    }

    function populateEntityFilters(types) {
        const container = document.getElementById('entity-type-filters');
        container.innerHTML = '';

        if (!types || types.length === 0) {
            container.innerHTML = '<span class="text-gray-500">No types yet. Run a query first.</span>';
            selectedEntityTypes.clear();
            return;
        }

        const available = new Set(types);
        selectedEntityTypes.forEach(type => {
            if (!available.has(type)) {
                selectedEntityTypes.delete(type);
            }
        });

        types.sort();
        types.forEach(type => {
            const button = document.createElement('button');
            button.className = 'entity-type-chip px-3 py-1 border border-indigo-200 rounded-full text-sm text-indigo-700 hover:bg-indigo-50 transition';
            button.dataset.type = type;
            button.textContent = type;

            if (selectedEntityTypes.has(type)) {
                button.classList.add('selected', 'bg-indigo-600', 'text-white', 'border-indigo-600');
            }

            button.addEventListener('click', () => {
                if (selectedEntityTypes.has(type)) {
                    selectedEntityTypes.delete(type);
                    button.classList.remove('selected', 'bg-indigo-600', 'text-white', 'border-indigo-600');
                } else {
                    selectedEntityTypes.add(type);
                    button.classList.add('selected', 'bg-indigo-600', 'text-white', 'border-indigo-600');
                }
                // Don't auto-search - let user select multiple types then click Search Archives
            });

            container.appendChild(button);
        });
    }

    function populateExcludeSourceFilters(sources) {
        const container = document.getElementById('exclude-sources-filters');
        if (!container) {
            console.error('exclude-sources-filters element not found');
            return;
        }
        container.innerHTML = '';

        if (!sources || sources.length === 0) {
            container.innerHTML = '<span class="text-gray-500">No sources available.</span>';
            return;
        }

        // Only show active sources for exclusion
        const activeSources = sources.filter(s => {
            const active = typeof s === 'object' ? s.active : true;
            return active;
        });

        if (activeSources.length === 0) {
            container.innerHTML = '<span class="text-gray-500">No active sources to exclude.</span>';
            return;
        }

        activeSources.forEach(entry => {
            const docId = typeof entry === 'string' ? entry : entry.id;
            const button = document.createElement('button');
            button.className = 'exclude-source-chip px-3 py-1 border border-gray-200 rounded-full text-sm text-gray-700 hover:bg-gray-50 transition';
            button.dataset.sourceId = docId;
            button.textContent = docId;

            if (excludedSources.has(docId)) {
                button.classList.add('excluded', 'bg-red-100', 'text-red-700', 'border-red-300');
            }

            button.addEventListener('click', () => {
                if (excludedSources.has(docId)) {
                    excludedSources.delete(docId);
                    button.classList.remove('excluded', 'bg-red-100', 'text-red-700', 'border-red-300');
                } else {
                    excludedSources.add(docId);
                    button.classList.add('excluded', 'bg-red-100', 'text-red-700', 'border-red-300');
                }
            });

            container.appendChild(button);
        });
    }

    function resetAllExcludedSources() {
        // Clear all excluded sources
        excludedSources.clear();
        
        // Refresh the UI by removing excluded styling from all buttons
        const container = document.getElementById('exclude-sources-filters');
        if (container) {
            const buttons = container.querySelectorAll('.exclude-source-chip');
            buttons.forEach(button => {
                button.classList.remove('excluded', 'bg-red-100', 'text-red-700', 'border-red-300');
            });
        }
    }

    async function loadSources() {
        const status = document.getElementById('source-status');
        const list = document.getElementById('sources-list');
        
        if (!status || !list) {
            console.error('Source management elements not found:', {status: !!status, list: !!list});
            return;
        }
        
        status.classList.remove('hidden');
        status.textContent = 'Loading sources...';
        list.innerHTML = '';

        try {
            const response = await fetch(`${API_BASE}/sources`);
            if (!response.ok) throw new Error(await response.text());
            const data = await response.json();

            // Update exclude filters
            populateExcludeSourceFilters(data.sources || []);

            if (!data.sources || data.sources.length === 0) {
                list.innerHTML = '<li class="text-gray-500">No documents found.</li>';
            } else {
                data.sources.forEach(entry => {
                    const docId = typeof entry === 'string' ? entry : entry.id;
                    const active = typeof entry === 'object' ? entry.active : true;
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between border border-gray-100 rounded-md px-3 py-2';
                    
                    // Create safe ID by replacing spaces and special characters
                    const safeId = docId.replace(/[^a-zA-Z0-9]/g, '_');
                    const actionsId = `actions-${safeId}`;
                    
                    const statusBadge = active
                        ? '<span class="text-xs text-green-700 bg-green-50 border border-green-100 px-2 py-0.5 rounded-full mr-3">Active</span>'
                        : '<span class="text-xs text-red-700 bg-red-50 border border-red-100 px-2 py-0.5 rounded-full mr-3">Removed</span>';
                    
                    li.innerHTML = `
                        <div class="flex items-center">
                            ${statusBadge}
                            <span class="font-semibold text-gray-800">${docId}</span>
                        </div>
                        <div class="flex items-center gap-2" id="${actionsId}">
                            <button class="text-sm text-indigo-700 font-semibold hover:underline" data-doc="${docId}" data-action="reingest">
                                Re-ingest
                            </button>
                        </div>
                    `;
                    
                    const actions = li.querySelectorAll(`#${actionsId} button`);
                    actions.forEach(button => {
                        const action = button.dataset.action;
                        if (action === 'reingest') {
                            button.addEventListener('click', () => reingestSource(docId, button));
                        }
                    });

                    const actionsContainer = li.querySelector(`#${actionsId}`);
                    if (active && actionsContainer) {
                        const removeButton = document.createElement('button');
                        removeButton.className = 'text-sm text-red-700 font-semibold hover:underline';
                        removeButton.textContent = 'Remove';
                        removeButton.addEventListener('click', () => removeSource(docId, removeButton));
                        actionsContainer.appendChild(removeButton);
                    } else if (active && !actionsContainer) {
                        console.error(`Actions container not found for ${docId} (ID: ${actionsId})`);
                    }

                    if (list) {
                        list.appendChild(li);
                    } else {
                        console.error('Cannot append to null list element');
                    }
                });
            }
            status.textContent = 'Sources loaded.';
            setTimeout(() => {
                if (status.textContent === 'Sources loaded.') {
                    status.classList.add('hidden');
                }
            }, 1500);
        } catch (error) {
            status.textContent = `Error loading sources: ${error.message}`;
        }
    }

    async function reingestSource(docId, button) {
        const status = document.getElementById('source-status');
        if (!confirm(`Re-ingest document "${docId}"? This will rebuild its Graphiti and Qdrant entries.`)) {
            return;
        }

        const originalText = button.textContent;
        button.textContent = 'Working...';
        button.disabled = true;
        status.classList.remove('hidden');
        status.textContent = `Re-ingesting ${docId}...`;

        try {
            const response = await fetch(`${API_BASE}/sources/${docId}/reingest`, {
                method: 'POST'
            });
            if (!response.ok) throw new Error(await response.text());
            await loadSources();
            status.textContent = `Successfully re-ingested ${docId}.`;
            setTimeout(() => status.classList.add('hidden'), 2000);
        } catch (error) {
            status.textContent = `Error re-ingesting ${docId}: ${error.message}`;
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    async function removeSource(docId, button) {
        const status = document.getElementById('source-status');
        if (!confirm(`Remove document "${docId}" from the index? This will delete its Graphiti and Qdrant entries.`)) {
            return;
        }

        const originalText = button.textContent;
        button.textContent = 'Removing...';
        button.disabled = true;
        status.classList.remove('hidden');
        status.textContent = `Removing ${docId}...`;

        try {
            const response = await fetch(`${API_BASE}/sources/${docId}`, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error(await response.text());
            status.textContent = `Removed ${docId}. Refreshing list...`;
            await loadSources();
        } catch (error) {
            status.textContent = `Error removing ${docId}: ${error.message}`;
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    async function uploadOCR() {
        const fileInput = document.getElementById('ocr-file');
        const docNameInput = document.getElementById('ocr-doc-name');
        const uploadButton = document.getElementById('ocr-upload-button');
        const statusDiv = document.getElementById('ocr-status');
        const messageSpan = document.getElementById('ocr-message');
        const spinner = document.getElementById('ocr-spinner');
        const previewDiv = document.getElementById('ocr-preview');
        const extractedTextArea = document.getElementById('ocr-extracted-text');

        if (!fileInput.files.length) {
            alert('Please select a file to upload.');
            return;
        }

        const file = fileInput.files[0];
        const docName = docNameInput.value.trim();

        const formData = new FormData();
        formData.append('file', file);
        if (docName) {
            formData.append('doc_name', docName);
        }

        uploadButton.disabled = true;
        uploadButton.textContent = 'Processing OCR...';
        statusDiv.classList.remove('hidden');
        spinner.classList.remove('hidden');
        previewDiv.classList.add('hidden');
        messageSpan.className = 'text-gray-600';
        messageSpan.textContent = 'Uploading file and extracting text...';

        try {
            const response = await fetch(`${API_BASE}/upload-ocr`, {
                method: 'POST',
                body: formData,
            });

            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.detail || 'Failed to process OCR.');
            }

            spinner.classList.add('hidden');
            messageSpan.className = 'text-green-600';
            messageSpan.textContent = `‚úì Success! Document "${data.doc_id}" added to archive (${data.extracted_text_length} characters extracted).`;
            
            // Show preview of extracted text
            extractedTextArea.value = data.preview || data.extracted_text || 'No preview available.';
            previewDiv.classList.remove('hidden');

            // Clear form
            fileInput.value = '';
            docNameInput.value = '';

            // Refresh sources list
            await loadSources();

            // Reset button after a delay
            setTimeout(() => {
                uploadButton.disabled = false;
                uploadButton.textContent = 'üìÑ Upload and Extract Text (OCR)';
                statusDiv.classList.add('hidden');
                previewDiv.classList.add('hidden');
            }, 5000);

        } catch (error) {
            spinner.classList.add('hidden');
            messageSpan.className = 'text-red-600';
            messageSpan.textContent = `Error: ${error.message}`;
            uploadButton.disabled = false;
            uploadButton.textContent = 'üìÑ Upload and Extract Text (OCR)';
        }
    }
</script>
</body>
</html>