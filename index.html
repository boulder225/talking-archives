<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Talking Archives - PoC</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h1 class="text-4xl font-bold text-indigo-900 mb-2">Talking Archives</h1>
        <p class="text-gray-600">AI-powered search for Indigenous historical documents</p>
        <p class="text-sm text-indigo-600 mt-2">‚úì Data Sovereignty ‚Ä¢ ‚úì Access Control ‚Ä¢ ‚úì Temporal Reasoning</p>
    </div>

    <!-- Search Box -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Ask a question about the documents:
            </label>
            <input
                    id="question"
                    type="text"
                    placeholder="e.g., What organizations are mentioned? What events happened over time?"
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none text-lg"
                    onkeypress="if(event.key==='Enter') search()"
            >
        </div>

        <!-- Example queries -->
        <div class="mb-4">
            <p class="text-xs text-gray-500 mb-2">Try these examples:</p>
            <div class="flex flex-wrap gap-2">
                <button onclick="setQuery('What are the main topics?')"
                        class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700">
                    Main topics
                </button>
                <button onclick="setQuery('What organizations are mentioned?')"
                        class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700">
                    Organizations
                </button>
                <button onclick="setQuery('Show me relationships between entities')"
                        class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700">
                    Relationships
                </button>
                <button onclick="setQuery('What events happened over time?')"
                        class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700">
                    Timeline
                </button>
            </div>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Focus on entity types (optional):
            </label>
            <div class="flex flex-wrap gap-2 text-sm" id="entity-type-filters">
                <span class="text-gray-500">No types yet. Run a query first.</span>
            </div>
        </div>

        <button
                onclick="search()"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 text-lg"
        >
            üîç Search Archives
        </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex items-center justify-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mr-3"></div>
            <span class="text-gray-600">Searching knowledge graph and documents...</span>
        </div>
    </div>

    <!-- Results -->
    <div id="results" class="hidden bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">üìÑ Answer</h2>
        <div id="answer" class="prose max-w-none mb-6 text-gray-800 whitespace-pre-wrap"></div>

        <!-- Knowledge Graph Section -->
        <div id="graph-section" class="border-t pt-4 mb-4 hidden">
            <h3 class="text-lg font-semibold text-gray-900 mb-3">üï∏Ô∏è Knowledge Graph</h3>

            <div class="mb-4">
                <h4 class="font-medium text-gray-700 mb-2 text-sm">Entities Found:</h4>
                <div id="entities" class="flex flex-wrap gap-2"></div>
            </div>

            <div id="relationships-container" class="hidden">
                <h4 class="font-medium text-gray-700 mb-2 text-sm">Relationships:</h4>
                <ul id="relationships" class="space-y-1 text-sm"></ul>
            </div>

            <div id="episodes-container" class="hidden mt-4">
                <h4 class="font-medium text-gray-700 mb-2 text-sm">Episodes:</h4>
                <ul id="episodes" class="space-y-2 text-sm"></ul>
            </div>
        </div>

        <!-- Sources Section -->
        <div id="sources-section" class="border-t pt-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-3">üìö Sources</h3>
            <ul id="sources" class="space-y-2"></ul>
        </div>
    </div>

    <!-- Footer -->
    <div class="mt-8 text-center text-gray-600 text-sm">
        <p class="font-semibold text-indigo-700">48-Hour Proof of Concept</p>
        <p class="mt-2">Architecture: Graphiti (Knowledge Graph) + Qdrant (Vector Search) + OpenAI (LLM)</p>
        <div class="mt-3 flex justify-center gap-4 text-xs">
            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">‚úì Data Sovereignty</span>
            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">‚úì Access Control</span>
            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">‚úì Audit Trail</span>
        </div>
    </div>

    <!-- Source Management -->
    <div class="mt-10 bg-white rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Source Management</h3>
                <p class="text-sm text-gray-500">Re-ingest individual documents after updates or removals.</p>
            </div>
            <button
                onclick="loadSources()"
                class="px-3 py-2 text-sm font-semibold text-indigo-700 border border-indigo-200 rounded-md hover:bg-indigo-50 transition"
            >
                Refresh List
            </button>
        </div>
        <div id="source-status" class="text-sm text-gray-500 mb-3 hidden"></div>
        <ul id="sources-list" class="space-y-2 text-sm text-gray-800"></ul>
    </div>
</div>

<script>
    let selectedEntityTypes = new Set();
    let isSearching = false;

    function setQuery(text) {
        document.getElementById('question').value = text;
        document.getElementById('question').focus();
    }

    async function search() {
        if (isSearching) return;
        const question = document.getElementById('question').value.trim();
        const selectedTypes = Array.from(selectedEntityTypes);

        if (!question) {
            alert('Please enter a question');
            return;
        }

        // Show loading, hide results
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('results').classList.add('hidden');

        isSearching = true;
        try {
            const response = await fetch('http://localhost:8080/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    user_id: 'researcher_1',
                    entity_types: selectedTypes
                })
            });

            const data = await response.json();
            populateEntityFilters(data.available_entity_types || []);

            // Hide loading
            document.getElementById('loading').classList.add('hidden');

            // Show answer
            document.getElementById('answer').textContent = data.answer;

            // Show knowledge graph data
            const graphSection = document.getElementById('graph-section');
            if (data.graph_entities && data.graph_entities.length > 0) {
                graphSection.classList.remove('hidden');

                const entitiesDiv = document.getElementById('entities');
                entitiesDiv.innerHTML = '';

                data.graph_entities.forEach(entity => {
                    const isSpecialized = entity.type && entity.type !== 'Entity';
                    const label = isSpecialized
                        ? `${entity.name || 'Unknown'} (${entity.type})`
                        : (entity.name || 'Unknown');

                    const button = document.createElement('button');
                    button.className = 'px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm font-medium hover:bg-indigo-200 transition';
                    button.textContent = label;
                    button.addEventListener('click', () => {
                        if (entity.name) {
                            askFollowUp(`Tell me more about ${entity.name}`);
                        }
                    });
                    entitiesDiv.appendChild(button);
                });

                // Show relationships if present
                if (data.graph_relationships && data.graph_relationships.length > 0) {
                    document.getElementById('relationships-container').classList.remove('hidden');

                    const relsList = document.getElementById('relationships');
                    relsList.innerHTML = '';

                data.graph_relationships.forEach(rel => {
                    const li = document.createElement('li');
                    li.className = 'text-gray-700 border border-gray-200 rounded-lg p-3 space-y-2';

                    if (rel.from || rel.to) {
                        const header = document.createElement('div');
                        header.className = 'flex items-center';
                        header.innerHTML = `
                            <span class="text-indigo-600 mr-2">‚Üí</span>
                            <span><strong>${rel.from || 'Unknown'}</strong>
                            <span class="text-gray-500 mx-2">${rel.type || 'connected to'}</span>
                            <strong>${rel.to || 'Unknown'}</strong></span>
                        `;
                        li.appendChild(header);
                    }

                    const factText = rel.fact || 'Relationship details unavailable';
                    const factDiv = document.createElement('div');
                    factDiv.className = 'text-sm text-gray-600';
                    factDiv.textContent = factText;
                    li.appendChild(factDiv);

                    if (rel.valid_from || rel.valid_to) {
                        const timeDiv = document.createElement('div');
                        timeDiv.className = 'text-xs text-gray-500';
                        timeDiv.textContent = `Valid: ${rel.valid_from || '?'} ‚Üí ${rel.valid_to || 'present'}`;
                        li.appendChild(timeDiv);
                    }

                    if (rel.followup_question) {
                        const button = document.createElement('button');
                        button.className = 'text-xs text-indigo-700 font-semibold hover:underline';
                        button.textContent = 'Ask follow-up';
                        button.addEventListener('click', () => askFollowUp(rel.followup_question));
                        li.appendChild(button);
                    }

                    relsList.appendChild(li);
                });
                } else {
                    document.getElementById('relationships-container').classList.add('hidden');
                }
            } else {
                graphSection.classList.add('hidden');
                populateEntityFilters([]);
            }

            const episodesContainer = document.getElementById('episodes-container');
            const episodesList = document.getElementById('episodes');
            if (data.graph_episodes && data.graph_episodes.length > 0) {
                graphSection.classList.remove('hidden');
                episodesContainer.classList.remove('hidden');
                episodesList.innerHTML = '';

                data.graph_episodes.forEach(episode => {
                    const li = document.createElement('li');
                    li.className = 'text-gray-700 border border-gray-200 rounded-lg p-3 space-y-2';

                    const title = document.createElement('div');
                    title.className = 'font-semibold text-indigo-800';
                    title.textContent = episode.name || 'Unnamed episode';
                    li.appendChild(title);

                    const date = document.createElement('div');
                    date.className = 'text-xs text-gray-500';
                    date.textContent = episode.reference_time || 'Unknown date';
                    li.appendChild(date);

                    const rawContent = (episode.content || '').trim();
                    const cleanedContent = rawContent.replace(/^\[Reference Time:[^\]]+\]\s*/i, '');
                    const previewLimit = 600;
                    const isTruncated = cleanedContent.length > previewLimit;
                    const previewText = isTruncated ? `${cleanedContent.slice(0, previewLimit).trim()}‚Ä¶` : cleanedContent;

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'text-sm text-gray-700 whitespace-pre-line bg-gray-50 border border-gray-100 rounded-md p-3';
                    contentDiv.textContent = previewText || 'No content available';
                    contentDiv.dataset.fullText = cleanedContent;
                    contentDiv.dataset.previewText = previewText;
                    contentDiv.dataset.expanded = 'false';
                    li.appendChild(contentDiv);

                    if (isTruncated) {
                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'text-xs text-indigo-700 font-semibold hover:underline';
                        toggleBtn.textContent = 'Show full text';
                        toggleBtn.addEventListener('click', () => {
                            const expanded = contentDiv.dataset.expanded === 'true';
                            contentDiv.dataset.expanded = (!expanded).toString();
                            contentDiv.textContent = expanded ? contentDiv.dataset.previewText : contentDiv.dataset.fullText;
                            toggleBtn.textContent = expanded ? 'Show full text' : 'Show less';
                        });
                        li.appendChild(toggleBtn);
                    }

                    episodesList.appendChild(li);
                });
            } else {
                episodesContainer.classList.add('hidden');
            }

            // Show sources
            const sourcesList = document.getElementById('sources');
            sourcesList.innerHTML = '';

            if (data.sources && data.sources.length > 0) {
                data.sources.forEach(source => {
                    const li = document.createElement('li');
                    li.className = 'flex items-start';
                    li.innerHTML = `
                        <span class="text-indigo-600 mr-2 mt-1">‚Ä¢</span>
                        <span class="text-gray-700">
                            <strong>${source.title}</strong>
                            <span class="text-gray-500 text-sm">(relevance: ${(source.relevance * 100).toFixed(1)}%)</span>
                        </span>
                    `;
                    sourcesList.appendChild(li);
                });
            } else {
                sourcesList.innerHTML = '<li class="text-gray-500 italic">No sources found</li>';
            }

            document.getElementById('results').classList.remove('hidden');

        } catch (error) {
            document.getElementById('loading').classList.add('hidden');
            alert('Error: ' + error.message);
            console.error(error);
        } finally {
            isSearching = false;
        }
    }

    // Focus on input on load
    window.onload = () => {
        document.getElementById('question').focus();
        loadSources();
    };

    function askFollowUp(question) {
        const input = document.getElementById('question');
        input.value = question;
        search();
    }

    function populateEntityFilters(types) {
        const container = document.getElementById('entity-type-filters');
        container.innerHTML = '';

        if (!types || types.length === 0) {
            container.innerHTML = '<span class="text-gray-500">No types yet. Run a query first.</span>';
            selectedEntityTypes.clear();
            return;
        }

        const available = new Set(types);
        selectedEntityTypes.forEach(type => {
            if (!available.has(type)) {
                selectedEntityTypes.delete(type);
            }
        });

        types.sort();
        types.forEach(type => {
            const button = document.createElement('button');
            button.className = 'entity-type-chip px-3 py-1 border border-indigo-200 rounded-full text-sm text-indigo-700 hover:bg-indigo-50 transition';
            button.dataset.type = type;
            button.textContent = type;

            if (selectedEntityTypes.has(type)) {
                button.classList.add('selected', 'bg-indigo-600', 'text-white', 'border-indigo-600');
            }

            button.addEventListener('click', () => {
                if (selectedEntityTypes.has(type)) {
                    selectedEntityTypes.delete(type);
                    button.classList.remove('selected', 'bg-indigo-600', 'text-white', 'border-indigo-600');
                } else {
                    selectedEntityTypes.add(type);
                    button.classList.add('selected', 'bg-indigo-600', 'text-white', 'border-indigo-600');
                }
                // Don't auto-search - let user select multiple types then click Search Archives
            });

            container.appendChild(button);
        });
    }

    async function loadSources() {
        const status = document.getElementById('source-status');
        const list = document.getElementById('sources-list');
        status.classList.remove('hidden');
        status.textContent = 'Loading sources...';
        list.innerHTML = '';

        try {
            const response = await fetch('http://localhost:8080/sources');
            if (!response.ok) throw new Error(await response.text());
            const data = await response.json();

            if (!data.sources || data.sources.length === 0) {
                list.innerHTML = '<li class="text-gray-500">No documents found.</li>';
            } else {
                data.sources.forEach(entry => {
                    const docId = typeof entry === 'string' ? entry : entry.id;
                    const active = typeof entry === 'object' ? entry.active : true;
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between border border-gray-100 rounded-md px-3 py-2';
                    const actionsId = `actions-${docId}`;
                    const statusBadge = active
                        ? '<span class="text-xs text-green-700 bg-green-50 border border-green-100 px-2 py-0.5 rounded-full mr-3">Active</span>'
                        : '<span class="text-xs text-red-700 bg-red-50 border border-red-100 px-2 py-0.5 rounded-full mr-3">Removed</span>';
                    li.innerHTML = `
                        <div class="flex items-center">
                            ${statusBadge}
                            <span class="font-semibold text-gray-800">${docId}</span>
                        </div>
                        <div class="flex items-center gap-2" id="${actionsId}">
                            <button class="text-sm text-indigo-700 font-semibold hover:underline" data-doc="${docId}" data-action="reingest">
                                Re-ingest
                            </button>
                        </div>
                    `;
                    const actions = li.querySelectorAll(`#${actionsId} button`);
                    actions.forEach(button => {
                        const action = button.dataset.action;
                        if (action === 'reingest') {
                            button.addEventListener('click', () => reingestSource(docId, button));
                        }
                    });

                    const actionsContainer = li.querySelector(`#${actionsId}`);
                    if (active) {
                        const removeButton = document.createElement('button');
                        removeButton.className = 'text-sm text-red-700 font-semibold hover:underline';
                        removeButton.textContent = 'Remove';
                        removeButton.addEventListener('click', () => removeSource(docId, removeButton));
                        actionsContainer.appendChild(removeButton);
                    }

                    list.appendChild(li);
                });
            }
            status.textContent = 'Sources loaded.';
            setTimeout(() => {
                if (status.textContent === 'Sources loaded.') {
                    status.classList.add('hidden');
                }
            }, 1500);
        } catch (error) {
            status.textContent = `Error loading sources: ${error.message}`;
        }
    }

    async function reingestSource(docId, button) {
        const status = document.getElementById('source-status');
        if (!confirm(`Re-ingest document "${docId}"? This will rebuild its Graphiti and Qdrant entries.`)) {
            return;
        }

        const originalText = button.textContent;
        button.textContent = 'Working...';
        button.disabled = true;
        status.classList.remove('hidden');
        status.textContent = `Re-ingesting ${docId}...`;

        try {
            const response = await fetch(`http://localhost:8080/sources/${docId}/reingest`, {
                method: 'POST'
            });
            if (!response.ok) throw new Error(await response.text());
            await loadSources();
            status.textContent = `Successfully re-ingested ${docId}.`;
            setTimeout(() => status.classList.add('hidden'), 2000);
        } catch (error) {
            status.textContent = `Error re-ingesting ${docId}: ${error.message}`;
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    async function removeSource(docId, button) {
        const status = document.getElementById('source-status');
        if (!confirm(`Remove document "${docId}" from the index? This will delete its Graphiti and Qdrant entries.`)) {
            return;
        }

        const originalText = button.textContent;
        button.textContent = 'Removing...';
        button.disabled = true;
        status.classList.remove('hidden');
        status.textContent = `Removing ${docId}...`;

        try {
            const response = await fetch(`http://localhost:8080/sources/${docId}`, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error(await response.text());
            status.textContent = `Removed ${docId}. Refreshing list...`;
            await loadSources();
        } catch (error) {
            status.textContent = `Error removing ${docId}: ${error.message}`;
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }
</script>
</body>
</html>